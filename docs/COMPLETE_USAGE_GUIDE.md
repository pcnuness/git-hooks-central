# üöÄ **Guia Completo de Uso - Git Hooks Central**

## üìã **√çndice**

1. [Vis√£o Geral](#-vis√£o-geral)
2. [Arquitetura](#-arquitetura)
3. [Instala√ß√£o](#-instala√ß√£o)
4. [Configura√ß√£o](#-configura√ß√£o)
5. [Hooks Dispon√≠veis](#-hooks-dispon√≠veis)
6. [Uso Di√°rio](#-uso-di√°rio)
7. [Troubleshooting](#-troubleshooting)
8. [Integra√ß√£o CI/CD](#-integra√ß√£o-cicd)
9. [Seguran√ßa](#-seguran√ßa)
10. [FAQ](#-faq)

---

## üéØ **Vis√£o Geral**

O **Git Hooks Central** √© um sistema de hooks Git baseado no framework `pre-commit` que executa verifica√ß√µes de seguran√ßa e qualidade de c√≥digo no est√°gio `pre-push`. O sistema √© projetado para ser:

- ‚úÖ **Multi-OS**: Windows, Linux, macOS
- ‚úÖ **Auto-gerenciado**: Virtual environment e depend√™ncias autom√°ticas
- ‚úÖ **Escal√°vel**: Cat√°logo central reutiliz√°vel
- ‚úÖ **Seguro**: Detec√ß√£o de segredos e vulnerabilidades
- ‚úÖ **Audit√°vel**: Rastreamento completo de execu√ß√µes

### **Fluxo de Trabalho:**
```mermaid
graph LR
    A[Developer Push] --> B[Pre-Push Hooks]
    B --> C[Security Checks]
    B --> D[Code Quality]
    B --> E[Secret Detection]
    C --> F[Pass/Fail]
    D --> F
    E --> F
    F --> G[Push Allowed/Blocked]
```

---

## üèóÔ∏è **Arquitetura**

### **Componentes Principais:**

#### **1. Cat√°logo Central**
```
https://github.com/pcnuness/git-hooks-central.git
‚îú‚îÄ‚îÄ hooks/                    # Scripts de hooks
‚îú‚îÄ‚îÄ .pre-commit-hooks.yaml   # Defini√ß√£o dos hooks
‚îú‚îÄ‚îÄ examples/                # Configura√ß√µes de exemplo
‚îî‚îÄ‚îÄ docs/                    # Documenta√ß√£o
```

#### **2. Hooks Dispon√≠veis**
- **`branch-ahead-check`**: Verifica se branch est√° atualizada
- **`audit-trail`**: Gera artefato audit√°vel
- **`secrets-detection-gitlab`**: Detec√ß√£o de segredos (Python Multi-OS)

#### **3. Tecnologias**
- **Framework**: pre-commit
- **Linguagem**: Python 3.6+ com Virtual Environment
- **Container**: Docker (GitLab Secrets Analyzer)
- **Multi-OS**: Compat√≠vel com Windows, Linux, macOS

---

## üîß **Instala√ß√£o**

### **Pr√©-requisitos**

#### **Sistema Operacional:**
- **Windows**: Windows 10/11 com Python 3.6+
- **Linux**: Ubuntu 18.04+, CentOS 7+, RHEL 7+
- **macOS**: macOS 10.15+ com Python 3.6+

#### **Ferramentas Obrigat√≥rias:**
```bash
# Python 3.6+ (obrigat√≥rio)
python3 --version  # Deve ser 3.6.0 ou superior

# Git (obrigat√≥rio)
git --version

# Docker (obrigat√≥rio para secrets detection)
docker --version
docker info  # Deve estar rodando
```

#### **Ferramentas Opcionais:**
```bash
# pre-commit (ser√° instalado automaticamente)
pip install pre-commit

# jq (para melhor parsing JSON)
# Linux: sudo apt-get install jq
# macOS: brew install jq
# Windows: choco install jq
```

### **Instala√ß√£o Passo a Passo**

#### **1. Clonar o Reposit√≥rio de Exemplo**
```bash
# Criar reposit√≥rio de teste
mkdir meu-projeto-seguro
cd meu-projeto-seguro
git init
```

#### **2. Configurar pre-commit**
```bash
# Instalar pre-commit
pip install pre-commit

# Criar .pre-commit-config.yaml
cat > .pre-commit-config.yaml << 'EOF'
repos:
  # Hooks nativos e r√°pidos
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: end-of-file-fixer
        stages: [pre-push]
      - id: check-json
        stages: [pre-push]
      - id: check-yaml
        stages: [pre-push]
      - id: detect-private-key
        stages: [pre-push]

  # Cat√°logo central de hooks de seguran√ßa
  - repo: https://github.com/pcnuness/git-hooks-central.git
    rev: v1.0.3  # ‚ö†Ô∏è SEMPRE usar tag espec√≠fica
    hooks:
      - id: branch-ahead-check
        stages: [pre-push]
        pass_filenames: false
      
      - id: audit-trail
        stages: [pre-push]
        pass_filenames: false
      
      - id: secrets-detection-gitlab
        stages: [pre-push]
        always_run: true
        pass_filenames: false
EOF
```

#### **3. Instalar Hooks**
```bash
# Instalar hooks no reposit√≥rio
pre-commit install --hook-type pre-push

# Verificar instala√ß√£o
pre-commit --version
```

#### **4. Testar Instala√ß√£o**
```bash
# Executar todos os hooks
pre-commit run --all-files --hook-stage push -v

# Resultado esperado: hooks executando sem erros
```

---

## ‚öôÔ∏è **Configura√ß√£o**

### **Configura√ß√£o B√°sica (.pre-commit-config.yaml)**

```yaml
repos:
  # Hooks nativos (obrigat√≥rios)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: end-of-file-fixer
        stages: [pre-push]
      - id: check-json
        stages: [pre-push]
      - id: check-yaml
        stages: [pre-push]
      - id: detect-private-key
        stages: [pre-push]

  # Cat√°logo central (SEMPRE usar tag espec√≠fica)
  - repo: https://github.com/pcnuness/git-hooks-central.git
    rev: v1.0.3  # ‚ö†Ô∏è NUNCA usar main ou latest
    hooks:
      - id: branch-ahead-check
        stages: [pre-push]
        pass_filenames: false
      
      - id: audit-trail
        stages: [pre-push]
        pass_filenames: false
      
      - id: secrets-detection-gitlab
        stages: [pre-push]
        always_run: true
        pass_filenames: false
```

### **Configura√ß√£o Avan√ßada**

#### **Para Projetos Node.js:**
```yaml
repos:
  # ... hooks b√°sicos ...

  # Cat√°logo central
  - repo: https://github.com/pcnuness/git-hooks-central.git
    rev: v1.0.3
    hooks:
      - id: branch-ahead-check
        stages: [pre-push]
        pass_filenames: false
      
      - id: audit-trail
        stages: [pre-push]
        pass_filenames: false
      
      - id: secrets-detection-gitlab
        stages: [pre-push]
        always_run: true
        pass_filenames: false

  # Hooks espec√≠ficos para Node.js
  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v9.34.0
    hooks:
      - id: eslint
        additional_dependencies: ['eslint@9.9.0']
        files: \.(js|jsx|ts|tsx)$
        stages: [pre-push]
        args: [--fix]
```

#### **Para Projetos Java:**
```yaml
repos:
  # ... hooks b√°sicos ...

  # Cat√°logo central
  - repo: https://github.com/pcnuness/git-hooks-central.git
    rev: v1.0.3
    hooks:
      - id: branch-ahead-check
        stages: [pre-push]
        pass_filenames: false
      
      - id: audit-trail
        stages: [pre-push]
        pass_filenames: false
      
      - id: secrets-detection-gitlab
        stages: [pre-push]
        always_run: true
        pass_filenames: false

  # Hooks espec√≠ficos para Java
  - repo: https://github.com/checkstyle/checkstyle
    rev: v10.12.4
    hooks:
      - id: checkstyle
        stages: [pre-push]
        files: \.java$
```

---

## üîß **Hooks Dispon√≠veis**

### **Hooks do Cat√°logo Central**

| Hook ID | Descri√ß√£o | Tempo Estimado | Depend√™ncias |
|---------|-----------|----------------|--------------|
| `branch-ahead-check` | Verifica se branch est√° atualizada com origin/main | <2s | Git |
| `audit-trail` | Gera artefato audit√°vel (.git/hooks_artifacts/prepush.json) | <5s | Git |
| `secrets-detection-gitlab` | Detec√ß√£o de segredos via GitLab Analyzer | <30s | Docker, Python 3.6+ |

### **Hooks Nativos (pre-commit-hooks)**

| Hook ID | Descri√ß√£o | Tempo Estimado |
|---------|-----------|----------------|
| `end-of-file-fixer` | Corrige final de arquivos (newline) | <1s |
| `check-json` | Valida sintaxe JSON | <1s |
| `check-xml` | Valida sintaxe XML | <1s |
| `check-yaml` | Valida sintaxe YAML | <1s |
| `detect-private-key` | Detecta chaves privadas | <5s |

### **Detalhamento dos Hooks**

#### **1. branch-ahead-check**
```bash
# Verifica se a branch local est√° atualizada com origin/main
# Falha se: branch local est√° atr√°s da remota
# Sucesso se: branch local est√° atualizada ou √† frente
```

#### **2. audit-trail**
```bash
# Gera arquivo: .git/hooks_artifacts/prepush.json
# Conte√∫do:
{
  "commit": "abc123...",
  "author": "Jo√£o Silva",
  "date": "2025-09-02T21:00:00Z",
  "precommit_config_sha1": "def456...",
  "status": "passed-local"
}
```

#### **3. secrets-detection-gitlab**
```bash
# Executa GitLab Secrets Analyzer via Docker
# Detecta: API keys, passwords, private keys, tokens
# Gera: gl-secret-detection-report.json
# Falha se: secrets detectados
# Sucesso se: nenhum secret encontrado
```

---

## üíª **Uso Di√°rio**

### **Fluxo de Trabalho Normal**

#### **1. Desenvolvimento**
```bash
# Fazer altera√ß√µes no c√≥digo
git add .
git commit -m "feat: nova funcionalidade"
```

#### **2. Push (Execu√ß√£o Autom√°tica dos Hooks)**
```bash
# Hooks executam automaticamente
git push origin feature-branch

# Se hooks falharem, push √© bloqueado
# Se hooks passarem, push √© permitido
```

#### **3. Execu√ß√£o Manual (Opcional)**
```bash
# Executar todos os hooks
pre-commit run --all-files --hook-stage push -v

# Executar hook espec√≠fico
pre-commit run secrets-detection-gitlab --all-files --hook-stage push

# Executar em arquivos espec√≠ficos
pre-commit run --files src/index.js --hook-stage push
```

### **Cen√°rios Comuns**

#### **Cen√°rio 1: Push Bem-sucedido**
```bash
$ git push origin feature-branch

[INFO] Configurando ambiente Python...
[SUCCESS] Ambiente Python configurado com sucesso
[INFO] Executando GitLab Secrets Analyzer...
[SUCCESS] Nenhum segredo sens√≠vel detectado
‚úÖ Branch atualizada em rela√ß√£o a origin/main.
‚úÖ Dependency audit r√°pido conclu√≠do.
‚úÖ Artefato audit√°vel salvo.

Enumerating objects: 3, done.
Counting objects: 100% (3/3), done.
Delta compression using up to 8 threads
Compressing objects: 100% (2/2), done.
Writing objects: 100% (2/2), 183 bytes | 183.00 KiB/s, done.
Total 2 (delta 1), reused 0 (delta 0), pack-reused 0
To https://github.com/user/repo.git
   abc123..def456  feature-branch -> feature-branch
```

#### **Cen√°rio 2: Push Bloqueado por Segredos**
```bash
$ git push origin feature-branch

[INFO] Configurando ambiente Python...
[SUCCESS] Ambiente Python configurado com sucesso
[INFO] Executando GitLab Secrets Analyzer...
[ERROR] Secrets detectados: 2 vulnerabilidade(s)
[ERROR] Arquivo: gl-secret-detection-report.json
‚Ä¢ RSA private key em src/index.js:14 (Severidade: Critical)
‚Ä¢ AWS access token em src/index.js:11 (Severidade: Critical)
[ERROR] Revise e remova credenciais antes do push
[INFO] Dicas: rotacione chaves, use vari√°veis de ambiente, adicione ao .gitignore

error: failed to push some refs to 'https://github.com/user/repo.git'
hint: Updates were rejected because the pre-push hook failed
```

#### **Cen√°rio 3: Branch Desatualizada**
```bash
$ git push origin feature-branch

‚ùå Branch n√£o est√° atualizada em rela√ß√£o a origin/main.
‚ùå Execute: git pull origin main

error: failed to push some refs to 'https://github.com/user/repo.git'
hint: Updates were rejected because the pre-push hook failed
```

---

## üîß **Troubleshooting**

### **Problemas Comuns**

#### **1. Docker n√£o encontrado**
```bash
# Erro:
[ERROR] Docker n√£o encontrado ou n√£o est√° em execu√ß√£o.

# Solu√ß√£o:
# Windows: Instalar Docker Desktop
# Linux: sudo apt-get install docker.io && sudo systemctl start docker
# macOS: brew install --cask docker
```

#### **2. Python n√£o encontrado**
```bash
# Erro:
python3: command not found

# Solu√ß√£o:
# Windows: Instalar Python 3.6+ do python.org
# Linux: sudo apt-get install python3
# macOS: brew install python3
```

#### **3. Virtual Environment falha**
```bash
# Erro:
[ERROR] Falha ao criar virtual environment

# Solu√ß√£o:
# Verificar permiss√µes
chmod +x hooks/secrets_detection_wrapper.py

# Verificar Python
python3 --version  # Deve ser 3.6.0+
```

#### **4. Hooks n√£o executam**
```bash
# Erro:
pre-commit: command not found

# Solu√ß√£o:
pip install pre-commit
pre-commit install --hook-type pre-push
```

#### **5. Cache corrompido**
```bash
# Limpar cache do pre-commit
pre-commit clean

# Reinstalar hooks
pre-commit install --hook-type pre-push
```

### **Comandos de Diagn√≥stico**

#### **Verificar Instala√ß√£o**
```bash
# Verificar pre-commit
pre-commit --version

# Verificar hooks instalados
ls -la .git/hooks/

# Verificar configura√ß√£o
cat .pre-commit-config.yaml
```

#### **Verificar Depend√™ncias**
```bash
# Verificar Python
python3 --version

# Verificar Docker
docker --version
docker info

# Verificar Git
git --version
```

#### **Verificar Logs**
```bash
# Executar com verbose
pre-commit run --all-files --hook-stage push -v

# Verificar artefatos
ls -la .git/hooks_artifacts/
cat .git/hooks_artifacts/prepush.json

# Verificar relat√≥rios
ls -la gl-secret-detection-report.json
```

---

## üîÑ **Integra√ß√£o CI/CD**

### **GitHub Actions**

```yaml
# .github/workflows/pre-commit-validation.yml
name: Pre-commit Validation

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install pre-commit
      run: pip install pre-commit
    
    - name: Run pre-commit
      run: pre-commit run --all-files --hook-stage push
    
    - name: Validate audit artifact
      run: |
        if [ -f .git/hooks_artifacts/prepush.json ]; then
          echo "‚úÖ Audit artifact found"
          cat .git/hooks_artifacts/prepush.json
        else
          echo "‚ùå Audit artifact missing"
          exit 1
        fi
```

### **GitLab CI**

```yaml
# .gitlab-ci.yml
stages:
  - pre-commit

pre-commit-validation:
  stage: pre-commit
  image: python:3.11
  before_script:
    - pip install pre-commit
  script:
    - pre-commit run --all-files --hook-stage push
    - |
      if [ -f .git/hooks_artifacts/prepush.json ]; then
        echo "‚úÖ Audit artifact found"
        cat .git/hooks_artifacts/prepush.json
      else
        echo "‚ùå Audit artifact missing"
        exit 1
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
```

### **Azure DevOps**

```yaml
# azure-pipelines.yml
trigger:
- main
- develop

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.11'

- script: |
    pip install pre-commit
    pre-commit run --all-files --hook-stage push
  displayName: 'Run pre-commit hooks'

- script: |
    if [ -f .git/hooks_artifacts/prepush.json ]; then
      echo "‚úÖ Audit artifact found"
      cat .git/hooks_artifacts/prepush.json
    else
      echo "‚ùå Audit artifact missing"
      exit 1
    fi
  displayName: 'Validate audit artifact'
```

---

## üîí **Seguran√ßa**

### **Medidas de Seguran√ßa Implementadas**

#### **1. Detec√ß√£o de Segredos**
- **GitLab Secrets Analyzer**: Detec√ß√£o avan√ßada de credenciais
- **Multi-pattern**: Detecta API keys, passwords, tokens, chaves privadas
- **Severidade**: Classifica√ß√£o por criticidade (Critical, High, Medium, Low)

#### **2. Preven√ß√£o de Bypass**
- **Artefato audit√°vel**: Rastreamento de execu√ß√µes
- **CI/CD validation**: Valida√ß√£o no pipeline
- **Server-side hooks**: √öltima linha de defesa

#### **3. Isolamento**
- **Virtual Environment**: Depend√™ncias isoladas
- **Docker containers**: Execu√ß√£o isolada
- **Multi-OS**: Compatibilidade sem comprometer seguran√ßa

### **Boas Pr√°ticas**

#### **1. Gerenciamento de Segredos**
```bash
# ‚ùå NUNCA fazer:
const apiKey = "sk-1234567890abcdef";

# ‚úÖ SEMPRE fazer:
const apiKey = process.env.API_KEY;
```

#### **2. Configura√ß√£o de .gitignore**
```bash
# Adicionar ao .gitignore:
.env
.env.local
.env.production
*.pem
*.key
secrets/
config/secrets.json
```

#### **3. Rota√ß√£o de Credenciais**
```bash
# Se segredos forem detectados:
# 1. Rotacionar imediatamente
# 2. Remover do c√≥digo
# 3. Usar vari√°veis de ambiente
# 4. Atualizar documenta√ß√£o
```

---

## ‚ùì **FAQ**

### **Perguntas Frequentes**

#### **Q: Por que usar pre-push em vez de pre-commit?**
**A:** Pre-push √© mais eficiente porque:
- Executa apenas quando c√≥digo est√° pronto para push
- Evita execu√ß√µes desnecess√°rias durante desenvolvimento
- Permite commits locais para testes
- Melhor experi√™ncia do desenvolvedor

#### **Q: Como atualizar para nova vers√£o do cat√°logo?**
**A:** 
```bash
# 1. Verificar tags dispon√≠veis
git ls-remote --tags https://github.com/pcnuness/git-hooks-central.git

# 2. Atualizar .pre-commit-config.yaml
# Mudar rev: v1.0.3 para rev: v1.0.4

# 3. Limpar cache e reinstalar
pre-commit clean
pre-commit install --hook-type pre-push
```

#### **Q: Posso desabilitar hooks temporariamente?**
**A:** 
```bash
# Op√ß√£o 1: Bypass com flag
git push --no-verify

# Op√ß√£o 2: Comentar no .pre-commit-config.yaml
# - id: secrets-detection-gitlab
#   stages: [pre-push]

# ‚ö†Ô∏è CUIDADO: Use apenas em emerg√™ncias
```

#### **Q: Como debugar hooks que falham?**
**A:**
```bash
# 1. Executar com verbose
pre-commit run --all-files --hook-stage push -v

# 2. Executar hook espec√≠fico
pre-commit run secrets-detection-gitlab --all-files --hook-stage push

# 3. Verificar logs
cat .git/hooks_artifacts/prepush.json
cat gl-secret-detection-report.json
```

#### **Q: Hooks s√£o executados em todos os arquivos?**
**A:** Depende da configura√ß√£o:
- `always_run: true` ‚Üí Executa em todos os arquivos
- `pass_filenames: false` ‚Üí N√£o passa lista de arquivos
- Sem essas op√ß√µes ‚Üí Executa apenas em arquivos modificados

#### **Q: Como personalizar regras de detec√ß√£o de segredos?**
**A:** O GitLab Secrets Analyzer usa regras padr√£o. Para personalizar:
```bash
# Criar arquivo de configura√ß√£o
cat > .gitlab/secret-detection-ruleset.toml << 'EOF'
[secrets]
  [secrets.custom_rule]
    description = "Custom API key pattern"
    regex = '''api[_-]?key[_-]?[=:]\s*['"]?([a-zA-Z0-9]{32,})['"]?'''
    severity = "critical"
EOF
```

#### **Q: Posso usar em reposit√≥rios privados?**
**A:** Sim! O sistema funciona com:
- Reposit√≥rios p√∫blicos
- Reposit√≥rios privados
- Reposit√≥rios corporativos
- Reposit√≥rios self-hosted

#### **Q: Como monitorar execu√ß√µes dos hooks?**
**A:**
```bash
# 1. Verificar artefatos
ls -la .git/hooks_artifacts/

# 2. Analisar relat√≥rios
cat gl-secret-detection-report.json | jq '.vulnerabilities'

# 3. Integrar com ferramentas de monitoramento
# (Prometheus, Grafana, etc.)
```

---

## üéâ **Conclus√£o**

O **Git Hooks Central** √© uma solu√ß√£o completa e robusta para seguran√ßa e qualidade de c√≥digo. Com sua arquitetura multi-OS, auto-gerenciamento e detec√ß√£o avan√ßada de segredos, oferece:

- ‚úÖ **Seguran√ßa**: Detec√ß√£o proativa de vulnerabilidades
- ‚úÖ **Qualidade**: Verifica√ß√µes autom√°ticas de c√≥digo
- ‚úÖ **Produtividade**: Integra√ß√£o transparente no fluxo de trabalho
- ‚úÖ **Auditoria**: Rastreamento completo de execu√ß√µes
- ‚úÖ **Escalabilidade**: Cat√°logo central reutiliz√°vel

**üöÄ Pronto para produ√ß√£o em qualquer ambiente!**

---

## üìû **Suporte**

Para d√∫vidas, problemas ou sugest√µes:
- **Issues**: [GitHub Issues](https://github.com/pcnuness/git-hooks-central/issues)
- **Documenta√ß√£o**: [docs/](docs/)
- **Exemplos**: [examples/](examples/)

**Vers√£o**: v1.0.3  
**√öltima atualiza√ß√£o**: 2025-09-02
